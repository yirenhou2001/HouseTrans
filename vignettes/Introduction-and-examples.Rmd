---
title: "Getting Started: Simulation and Estimation for Household Transmission"
author: "Your Name"
date: "`r format(Sys.Date())`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Getting Started: Simulation and Estimation for Household Transmission}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", eval = FALSE)
```

## Overview

This package provides a streamlined pipeline to simulate household infection dynamics, estimate transmission parameters, and visualize epidemic spread. It uses a Bayesian approach with Stan that models transmission probability as a function of viral load, seasonality, and role-specific susceptibility.

This vignette shows how to use the two core functions:

* **`GenSyn()`**: Generates synthetic data and runs the full estimation pipeline (ideal for validation and benchmarking)

* **`TransmissionChainAnalysis()`**: Estimates parameters from your own data

## Installation

```{r}
# Install from GitHub
devtools::install_github("yirenhou2001/Household.Transmission.Chain.Data.Analysis")

library(Household.Transmission.Chain.Data.Analysis)
```

## Expected Data Format

### Per-person episode table (recommended)

| Column             | Description                                    |
|--------------------|------------------------------------------------|
| `hh_id`            | Household identifier                           |
| `person_id`        | Individual ID within household                 |
| `role`             | Family role: "adult", "child", "toddler", "elderly" |
| `infection_time`   | Day of infection onset (NA if not infected)    |
| `infectious_start` | Day infectiousness begins                      |
| `infectious_end`   | Day infectiousness ends                        |
| `infection_resolved` | Day infection resolves                       |

### Long-format testing table

| Column             | Description                                    |
|--------------------|------------------------------------------------|
| `HH`               | Household identifier                           |
| `individual_ID`    | Individual ID within household                 |
| `role`             | Family role                                    |
| `test_date`        | Integer day or Date object                     |
| `infection_status` | Binary (0/1) indicating positive test          |

## Example 1: Synthetic Simulation and Estimation

Use `GenSyn()` to simulate household transmission data and estimate parameters in one call:

```{r}
library(Household.Transmission.Chain.Data.Analysis)

# Define seasonal forcing for each role (length must match max_days)
seasonal_forcing_list <- list(
  adult   = rep(0.1, 365),
  child   = rep(0.1, 365),
  elderly = rep(0.1, 365),
  toddler = rep(0.1, 365)
)

result <- GenSyn(
  n_households = 50,
  print_plots  = FALSE,
  
  # Seasonal forcing
  seasonal_forcing_list = seasonal_forcing_list,
  max_days = 365,
  
  # Stan sampling controls
  stan_chains  = 4,
  stan_iter    = 2000,
  stan_warmup  = 1000,
  stan_control = list(adapt_delta = 0.99, max_treedepth = 20),
  stan_cores   = 4
)

# View posterior summary
print(result$postprocessing)
```

### Understanding the output

The result object contains:

- `result$postprocessing`: Posterior summary with mean, SD, and credible intervals
- `result$results$fit`: The full `stanfit` object for further analysis
- `result$plot_list`: Generated plots (if requested)

## Example 2: Analyzing Your Own Data

Use `TransmissionChainAnalysis()` when you have observational data:

```{r}
# Create example per-person episode data
T_max <- 30
df_person <- data.frame(
  hh_id             = c("HH1","HH1","HH1","HH2","HH2","HH2"),
  person_id         = c(1, 2, 3, 1, 2, 3),
  role              = c("adult","child","elderly","adult","child","elderly"),
  infection_time    = c(2, 4, NA, 1, 3, NA),
  infectious_start  = c(3, 6, NA, 2, 5, NA),
  infectious_end    = c(8, 9, NA, 7, 9, NA),
  infection_resolved= c(9, 10, NA, 8, 10, NA)
)

# Optional: add viral load trajectories
df_person$vl_full_trajectory <- vector("list", nrow(df_person))

# Define seasonal forcing (length must match max_days)
seasonal_forcing_list <- list(
  adult   = rep(1, T_max),
  child   = rep(1, T_max),
  elderly = rep(1, T_max),
  toddler = rep(1, T_max)
)

result <- TransmissionChainAnalysis(
  user_data             = df_person,
  seasonal_forcing_list = seasonal_forcing_list,
  max_days              = T_max,
  
  # Light Stan settings for quick testing
  stan_chains  = 1,
  stan_iter    = 500,
  stan_warmup  = 250,
  stan_control = list(adapt_delta = 0.98, max_treedepth = 12),
  stan_cores   = 1
)

# View results
print(result)
```

## Key Parameters

### Transmission model parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `alpha_comm_by_role` | Community acquisition rate | 0.005 |
| `beta1` | Baseline transmission coefficient | 0.3 |
| `beta2` | Viral load transmission coefficient | 0.05 |
| `phi_by_role` | Susceptibility multipliers by role | adult=1, child=7, toddler=7, elderly=4 |
| `kappa_by_role` | Infectivity multipliers by role | adult=1, child=1.5, toddler=1.5, elderly=1 |

### Testing/detection parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `surveillance_interval` | Days between scheduled tests | 7 |
| `test_daily` | Switch to daily after first detection | FALSE |
| `detect_threshold_log10` | VL detection threshold (log10) | 1 |
| `viral_testing` | Testing mode: "viral load" or "Ct" | "viral load" |

### Stan sampling parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `stan_chains` | Number of MCMC chains | 4 |
| `stan_iter` | Total iterations per chain | 2000 |
| `stan_warmup` | Warmup iterations | 1000 |
| `stan_control` | Control parameters (adapt_delta, max_treedepth) | list(adapt_delta=0.99, max_treedepth=20) |

## Visualizing Results

When using `GenSyn` or when simulated data is available, you can generate diagnostic plots:

```{r}
result <- GenSyn(
  n_households = 50,
  plots = c("daily", "weekly", "timeline", "sar"),
  print_plots = TRUE,
  seasonal_forcing_list = seasonal_forcing_list
)

# Access individual plots
result$plot_list$daily     # Daily infections by role
result$plot_list$weekly    # Weekly infections by role
result$plot_list$timeline  # Infection timeline per household
result$plot_list$sar       # SAR by index case viral load
```

### Available plots

* **`"daily"`**: Daily new infections aggregated by role
* **`"weekly"`**: Weekly new infections aggregated by role
* **`"timeline"`**: Per-household charts showing infection and detection timing
* **`"sar"`**: Secondary attack rate stratified by index case viral load

## Model Details

### Estimated parameters

The Stan model estimates:

- **`phi[role]`**: Role-specific susceptibility multipliers (adult, child, toddler, elderly)
- **`kappa[role]`**: Role-specific infectivity multipliers
- **`latent_mean`**: Mean latent period with soft-gate transition to infectiousness

### Viral load dynamics

Viral load trajectories are simulated using a double-exponential model:

$$V(t) = \frac{2 \times 10^{v_p}}{\exp(-\lambda_g(t-t_p)) + \exp(\lambda_d(t-t_p))}$$

where:
- $v_p$ = peak viral load (log10)
- $t_p$ = time to peak
- $\lambda_g$ = growth rate
- $\lambda_d$ = decay rate

### Transmission probability

Within-household transmission probability at time $t$ for person $j$ is:

$$P_j(t) = 1 - \exp\left(-\phi_j \left(\alpha_{comm} \cdot S(t) + \sum_{i \neq j} h_{ij}(t)\right)\right)$$

where $h_{ij}(t)$ incorporates the infectivity of person $i$, their viral load, and contact structure.

## Tips for Production Use

1. **Increase Stan iterations** for final analyses (iter=4000, warmup=2000)
2. **Use multiple chains** (chains=4) to assess convergence
3. **Check diagnostics**: Look at Rhat values and effective sample sizes
4. **Adjust adapt_delta** if you see divergent transitions (try 0.99 or higher)

```{r}
# Production settings example
result <- GenSyn(
  n_households = 200,
  stan_chains  = 4,
  stan_iter    = 4000,
  stan_warmup  = 2000,
  stan_control = list(adapt_delta = 0.99, max_treedepth = 15),
  stan_cores   = 4
)

# Check convergence diagnostics
fit <- result$results$fit
rstan::check_hmc_diagnostics(fit)
```
